<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>موسم واحد</title>

  <!-- تحسينات اتصال سريعة للمجالات الكبيرة -->
  <link rel="preconnect" href="https://vk.com" crossorigin>
  <link rel="dns-prefetch" href="https://vk.com">
  <link rel="preconnect" href="https://mega.nz" crossorigin>
  <link rel="dns-prefetch" href="https://mega.nz">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .search-box { margin-bottom: 20px; }
    input {
      padding: 10px;
      width: 150px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      margin-left: 10px;
    }
    button {
      background-color: orange;
      color: #111;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .episodes {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-width: 800px;
      margin: auto;
    }
    .episode-btn {
      background-color: #2a2a2a;
      color: #ddd;
      border: none;
      padding: 14px 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      transition: background-color 0.3s;
      text-decoration: none;
      display: block;
      /* لا تغييرات مرئية إضافية لضمان نفس الشكل */
    }
    .episode-btn:hover {
      background-color: orange;
      color: #111;
    }
  </style>
</head>
<body>

  <h2>موسم واحد</h2>

  <div class="search-box">
    <input type="number" id="episodeNumber" placeholder="رقم الحلقة" min="1" max="40">
    <button id="playBtn">تشغيل</button>
  </div>

  <div class="episodes" id="episodesList"></div>

  <script>
    const episodes = [
      "https://vk.com/video1060594069_456239249?list=ln-LxbpbzLMt7N7zDcPi0",
      "https://vk.com/video1060594069_456239250?list=ln-cmbiJvUovawxiWyB6e",
      "https://vk.com/video1060594069_456239251?list=ln-I71jlufFnbJEtTZDMX",
      "https://vk.com/video1060594069_456239252?list=ln-UbZeC8KlylLhYuWCnp",
      "https://vk.com/video1060594069_456239253?list=ln-EbYM9MaYBq8jrm98Yx",
      "https://vk.com/video1060594069_456239254?list=ln-DI0BBdtCCnfFHoiwtf",
      "https://vk.com/video1060594069_456239255?list=ln-m8Y2Xf51zIfImeBbMX",
      "https://vk.com/video1060594069_456239256?list=ln-Os3dzOvsKRb1FAeLkC",
      "https://vk.com/video1060594069_456239257?list=ln-FoldMFQQZ6AYErCXga",
      "https://vk.com/video1060594069_456239258?list=ln-AZNFIAPB5kQhrNa7Vj",
      "https://vk.com/video1060594069_456239259?list=ln-EMF5kA7U2SzK7rcmMV",
      "https://vk.com/video1060594069_456239260?list=ln-4DFOYzyt6qlqtqJM3p",
      "https://vk.com/video1060594069_456239261?list=ln-UXANfrj689wa3zag5B",
      "https://vk.com/video1060594069_456239262?list=ln-N2QnzghED15kGNwhYN",
      "https://vk.com/video1060594069_456239263?list=ln-7QiWbpxhMroGtLWsDE",
      "https://vk.com/video1060594069_456239264?list=ln-7S9YXlu08lkZrKizhD",
      "https://vk.com/video1060594069_456239265?list=ln-XN6ANrdzMsJULFsXDr",
      "https://vk.com/video1060594069_456239266?list=ln-okbDXb8iOdOq83Y3BN",
      "https://vk.com/video1060594069_456239267?list=ln-EU1TQ1CvUEGO8t1YS1",
      "https://vk.com/video1060594069_456239268?list=ln-r4IfdFzoZGVzW8CLr0",
      "https://mega.nz/file/bFcimYoA#PJzPFh96-gIC_l6-OostEHt21HM3aQLPlKDwfGJpG78",
      "https://vk.com/video1060594069_456239269?list=ln-d5ZFR7FvYunflEQakR",
      "https://vk.com/video1060594069_456239270?list=ln-dsvgGZImbKSTQLicwE",
      "https://vk.com/video1060594069_456239271?list=ln-S9gDHiBacUgpHkUdZ5",
      "https://vk.com/video1060594069_456239272?list=ln-8MyIcbApmzQ2G3q1bX",
      "https://vk.com/video1060594069_456239273?list=ln-igPaDFUe7zGRlPFTwO",
      "https://vk.com/video1060594069_456239274?list=ln-PKfwuzCB9jPTXstIZ3",
      "https://vk.com/video1060594069_456239275?list=ln-abf2RK9AhGIyicpc7c",
      "https://vk.com/video1060594069_456239276?list=ln-WB1t9ZEmQFgRwfjLbL",
      "https://vk.com/video1060594069_456239277?list=ln-kZ3nKK5e60j8DKEhfl",
      "https://vk.com/video1060594069_456239278?list=ln-mN15tSSbBusCoKytbL",
      "https://vk.com/video1060594069_456239279?list=ln-0YF4XzBpDKIxZD4KHS",
      "https://vk.com/video1060594069_456239280?list=ln-XPZ1FsCwuTpIR4QBbr",
      "https://vk.com/video1060594069_456239291?list=ln-5YKhzAMfH5dwqomkXd",
      "https://vk.com/video1060594069_456239285?list=ln-jbnDhY9juTkkgkRSJi",
      "https://vk.com/video1060594069_456239286?list=ln-o4jdtNey9t55BdWM3a",
      "https://vk.com/video1060594069_456239287?list=ln-XMEAeAPyXvgbeDPado",
      "https://vk.com/video1060594069_456239288?list=ln-scFYZSguddOK3TOIYB",
      "https://vk.com/video1060594069_456239289?list=ln-oW4KdYzcTyFOnp8ZnK",
      "https://vk.com/video1060594069_456239290?list=ln-NqU5mzM7JVpQeACsDP"
    ];

    // render بدون تغيير الشكل
    function renderEpisodes() {
      const container = document.getElementById("episodesList");
      container.innerHTML = "";
      episodes.forEach((url, index) => {
        const a = document.createElement("a");
        a.href = url;
        a.className = "episode-btn";
        a.innerText = `حلقة ${index + 1}`;
        a.setAttribute('data-url', url);
        a.title = "موجه مباشر — سيتم الانتقال فوراً";

        // التوجيه المباشر: عند gesture (pointerdown / touchstart / mousedown) نوجّه مباشرة
        const directNavigate = (ev) => {
          // نستخدم assign للتوجيه في نفس النافذة فوراً بدون أي انتظار
          // (لا نفتح تبويب جديد لأن المطلوب توجيه مباشر)
          try {
            window.location.assign(url);
          } catch (e) {
            // fallback آمن لو منع المتصفح assign (نادراً)
            window.location.href = url;
          }
          // منع أي أفعال لاحقة
          ev.preventDefault && ev.preventDefault();
        };

        // ربط الأحداث التي تُعتبر gesture على أغلب الأجهزة
        a.addEventListener('pointerdown', directNavigate, { passive: true });
        a.addEventListener('touchstart', directNavigate, { passive: true });
        a.addEventListener('mousedown', directNavigate, { passive: true });

        // دعم الكيبورد: Enter/Space يوجّه مباشرة
        a.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            try { window.location.assign(url); } catch (e) { window.location.href = url; }
          }
        });

        // منع فتح افتراضي غير مرغوب (لو بقي) لتفادي سلوك مزدوج
        a.addEventListener('click', (ev) => {
          ev.preventDefault();
        }, false);

        container.appendChild(a);
      });
    }

    // تشغيل من الرقم في الخانة: توجيه مباشر داخل gesture
    const playBtn = document.getElementById('playBtn');
    playBtn.addEventListener('pointerdown', () => {
      const num = parseInt(document.getElementById("episodeNumber").value);
      if (num >= 1 && num <= episodes.length) {
        try { window.location.assign(episodes[num - 1]); }
        catch (e) { window.location.href = episodes[num - 1]; }
      } else {
        alert("رقم الحلقة غير صحيح!");
      }
    }, { passive: true });

    // فحص روابط (يبقى متاحاً لكن لا ينتظر لفتح الروابط)
    async function checkLinkReachable(url, timeout = 4000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, { method: 'HEAD', signal: controller.signal, mode: 'no-cors' });
        clearTimeout(id);
        if (res.type === 'opaque') return { ok: null, reason: 'opaque (CORS/no-cors)' };
        return { ok: res.ok, status: res.status };
      } catch (err) {
        clearTimeout(id);
        return { ok: null, error: String(err) };
      }
    }

    async function batchCheckAll() {
      const links = Array.from(document.querySelectorAll('.episode-btn'));
      const batch = 6;
      for (let i = 0; i < links.length; i += batch) {
        const slice = links.slice(i, i + batch);
        await Promise.all(slice.map(async (a) => {
          const url = a.dataset.url || a.href;
          try {
            const res = await checkLinkReachable(url, 3000);
            if (res.ok === true) a.title = `متاح — ${res.status || ''}`;
            else if (res.ok === false) a.title = `غير متاح — ${res.status || ''}`;
            else a.title = `غير مؤكد (CORS/timeout)`;
          } catch (e) { a.title = `خطأ فحص`; }
        }));
      }
    }

    // render وتشغيل الفحص بعد تأخير بسيط
    renderEpisodes();
    setTimeout(() => batchCheckAll().catch(()=>{}), 600);

    // prefetch أول حلقتين (اختياري)
    (function addPrefetch() {
      try {
        for (let i = 0; i < Math.min(2, episodes.length); i++) {
          const l = document.createElement('link');
          l.rel = 'prefetch';
          l.href = episodes[i];
          document.head.appendChild(l);
        }
      } catch (e) {}
    })();
  </script>

</body>
</html>